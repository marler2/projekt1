<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Animal game</title>
    <link rel="stylesheet" type="text/css" href="/main.css" />
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript" src="jquery.js"></script>
       
</head>
<body>
    <h1 id="question">Animal quiz</h1>
        <table id="questionForm">
            <tr id="questionNode"></tr>       
        </table>
        <input type="submit" id="btnSubmit" value="Send reply">
    <script type="text/javascript">
        $(document).ready(function(){

            /** om gissat rätt så komma upp ett grattis med
            hur många frågor det tog att komma dit, antalet frågor
            sköts av servern, men meddelandet sköts här*/

            /**lägg in promises .then(success(), fail())
            anonyma funktioner*/

            /**separera ut jqueryn och serverns javascript i andra
            filer !!*/

            /*  $(document).on("keypress", function (e) {
                    if(e.which == "enter"){
                        doGet('/questions');
                    }
                }); */

            let latestServerString = '';

            function doPost(url, data){
                $.post(url, JSON.stringify(data),function (result){
                    //questionGenerator(doGet('/questions'));

                        /**här har vi fått tillbaka en string från servern
                         * beroende på vad det är för innehåll eller om spelet har nått sitt slut
                         * så uppdateras textfältet
                        */
                        if(JSON.parse(result).endsWith('?')){
                            questionGenerator(JSON.parse(result));
                            latestServerString = JSON.parse(result);
                        }else if(JSON.parse(result) == 'CONGRATULATIONS'){
                            questionGenerator('I won!');
                            setTimeout(function (){
                                location.reload(false);
                            },5000);
                        }else if(JSON.parse(result) == 'RETRY'){
                            questionGenerator('I lost!');
                            setTimeout(function(){
                                location.reload(false);
                            }, 5000);
                        }else if(JSON.parse(result) == 'QUESTIONLIMIT'){
                            questionGenerator('You have used all your 20 questions, i win!');
                            setTimeout(function(){
                                location.reload(false);
                            }, 5000);
                        }else{
                            questionGenerator('Is it a ' + JSON.parse(result) + ' ?');
                            latestServerString = JSON.parse(result);
                        }
                });
            };

            /**get request*/
            
            function doGet(url){
                    $.get(url, function(data, status){ 
                        console.log(data);
                        if(JSON.parse(data).endsWith('?')){
                            /**selecta books från data objektet, första i arrayn och dess titel */
                            questionGenerator(JSON.parse(data));
                            latestServerString = JSON.parse(data);
                        }else{
                            questionGenerator('Is it a '+ JSON.parse(data)+ '?');
                            latestServerString = JSON.parse(data);
                        }
                    });
            }
            
            /**uppdaterar tablen med nya frågor*/

            function questionGenerator(Question){

                $('#questionNode tr').remove();

                let html = "";
                    
                html = "<tr><td><p id='question'>"+Question+
                            "</p><input type='text' name='question'></td></tr><br/>"
                    
                $('#questionNode').append(html);

            };

            /**samla upp questionTable:ns innehåll och göra om det till en array som
            skickas till servern*/

            function questionCollector(){
                
                let body = [];


                $('input:text').each(function(){
                    body.push(($(this).val()));
                    //answerArray.push($(this).val());
                });

                // $('#questionNode tr').each(function(index){
                //     body.push($(this).text());            
                //     //body.push($(this).text()+answerArray[index]);
                //     });  

                body.push(latestServerString);

                    console.log("såhär ser questionCollectorBodyn ut: " + body);
                return body;
            };
            
            /** detta händer när sidan laddas*/
            /**uppdaterar frågefältet*/

            doGet('/questions');


              /**
             *  Submit click event 
             */

            $('#btnSubmit').click(function(event) {

                event.preventDefault();

                /**samla upp frågor som finns
                 * skickar dom till servern så den kan processa det
                */

                doPost('/questions',questionCollector());

            });

        });   
    </script> 
</body>
</html>